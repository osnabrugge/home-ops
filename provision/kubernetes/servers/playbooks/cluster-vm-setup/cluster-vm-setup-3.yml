---
- name: Cluster Setup
  hosts:
    - tiny03
  become: true
  gather_facts: true
  any_errors_fatal: true
  pre_tasks:
    - name: Pausing for 2 seconds...
      ansible.builtin.pause:
        seconds: 2
  tasks:

    - name: create {{ vm.master3_name }}
      command: "qm clone 3{{ vm.template_id }} {{ vm.master3_id }} --name {{ vm.master3_name }} --format qcow2 --full --storage nfs-nas"

    - name: resize {{ vm.master3_name }} disk
      command: "qm resize {{ vm.master3_id }} scsi0 100G"

    - name: set {{ vm.master3_name }} hardware
      command: "qm set {{ vm.master3_id }} --boot order=scsi0;ide2 --efidisk0 local-lvm:1,format=raw,efitype=4m --bios ovmf --cpu cputype=host --cores {{ vm.master_cores }} --memory {{ vm.master_memory }} --net0 virtio,bridge=vmbr0 --cicustom user=nfs-nas:snippets/{{ vm.master3_name }}-user.yaml,network=nfs-nas:snippets/{{ vm.master3_name }}-network.yaml,meta=nfs-nas:snippets/meta.yaml"

    - name: start {{ vm.master3_name }}
      command: "qm start {{ vm.master3_id }}"

    - name: create {{ vm.worker3_name }}
      command: "qm clone 3{{ vm.template_id}} {{ vm.worker3_id }} --name {{ vm.worker3_name }} --format raw --full --storage local-lvm"

    - name: resize {{ vm.worker3_name }} disk
      command: "qm resize {{ vm.worker3_id }} scsi0 100G"

    - name: set {{ vm.worker3_name }} hardware
      command: "qm set {{ vm.worker3_id }} --boot order=scsi0;ide2 --efidisk0 local-lvm:1,format=raw,efitype=4m --bios ovmf --cpu cputype=host --cores {{ vm.worker_cores }} --memory {{ vm.worker_memory }} --net0 virtio,bridge=vmbr0 --net1 virtio,bridge=vmbr1 --net2 virtio,bridge=vmbr2 --cicustom user=nfs-nas:snippets/{{ vm.worker3_name }}-user.yaml,network=nfs-nas:snippets/{{ vm.worker3_name }}-network.yaml,meta=nfs-nas:snippets/meta.yaml -scsi1 /dev/disk/by-id/nvme-Samsung_SSD_970_EVO_Plus_1TB_S6S1NS0T404382B"

    - name: start {{ vm.worker3_name }}
      command: "qm start {{ vm.worker3_id }}"

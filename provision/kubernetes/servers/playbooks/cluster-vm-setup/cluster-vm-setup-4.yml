---
- name: Cluster Setup
  hosts:
    - tiny04
  become: true
  gather_facts: true
  any_errors_fatal: true
  pre_tasks:
    - name: Pausing for 2 seconds...
      ansible.builtin.pause:
        seconds: 2
  tasks:

    - name: create {{ vm.worker4_name }}
      command: "qm clone 4{{ vm.template_id}} {{ vm.worker4_id }} --name {{ vm.worker4_name }} --format raw --full --storage local-lvm"

    - name: resize {{ vm.worker4_name }} disk
      command: "qm resize {{ vm.worker4_id }} scsi0 100G"

    - name: set {{ vm.worker4_name }} hardware
      command: "qm set {{ vm.worker4_id }} --boot order=scsi0;ide2 --efidisk0 local-lvm:1,format=raw,efitype=4m --bios ovmf --balloon 0 --machine q35 --cpu host --cores {{ vm.worker_cores }} --memory {{ vm.worker_memory }} --net0 virtio,bridge=vmbr0,macaddr={{ vm.worker4_mac }} -hostpci0 02:10.0,pcie=1 -hostpci1 02:10.2,pcie=1 -hostpci2 02:10.4,pcie=1 -hostpci3 02:10.6,pcie=1 --cicustom user=nfs-nas:snippets/{{ vm.worker4_name }}-user.yml,network=nfs-nas:snippets/{{ vm.worker4_name }}-network.yml,meta=nfs-nas:snippets/meta.yml -scsi1 /dev/disk/by-id/nvme-Samsung_SSD_970_EVO_Plus_1TB_S6S1NS0T404489F -hostpci4 00:02,mdev=i915-GVTg_V5_4,pcie=1"

    - name: start {{ vm.worker4_name }}
      command: "qm start {{ vm.worker4_id }}"
